name: Ultimate Professional Fix
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'

      - name: Master Build
        run: |
          # پروجیکٹ بنانا
          flutter create --project-name=masail_ka_hal --platforms=android . || true
          
          # کوٹلن ورژن کو خودکار طور پر 1.9.0 پر اپ ڈیٹ کرنا (ایرر فکس)
          sed -i "s/ext.kotlin_version = '1.7.1'/ext.kotlin_version = '1.9.0'/g" android/build.gradle
          sed -i "s/ext.kotlin_version = \"1.7.1\"/ext.kotlin_version = \"1.9.0\"/g" android/build.gradle
          
          # ضروری پیکیجز کا اضافہ
          flutter pub add webview_flutter webview_flutter_android permission_handler location || true
          
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';
          import 'package:webview_flutter/webview_flutter.dart';
          import 'package:webview_flutter_android/webview_flutter_android.dart';
          import 'package:permission_handler/permission_handler.dart';
          import 'package:location/location.dart' as loc;

          void main() => runApp(const MaterialApp(
            home: SafeArea(child: AppBody()), 
            debugShowCheckedModeBanner: false,
          ));

          class AppBody extends StatefulWidget {
            const AppBody({super.key});
            @override State<AppBody> createState() => _AppBodyState();
          }

          class _AppBodyState extends State<AppBody> {
            late final WebViewController controller;
            bool isLoading = true;
            bool hasError = false;

            @override
            void initState() {
              super.initState();
              _setupApp();
            }

            Future<void> _setupApp() async {
              // آٹومیٹک GPS آن کروانا
              loc.Location location = loc.Location();
              bool serviceEnabled = await location.serviceEnabled();
              if (!serviceEnabled) {
                serviceEnabled = await location.requestService();
              }
              
              await Permission.location.request();

              controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..setNavigationDelegate(NavigationDelegate(
                  onPageStarted: (url) => setState(() { isLoading = true; hasError = false; }),
                  onPageFinished: (url) => setState(() { isLoading = false; }),
                  onWebResourceError: (error) => setState(() => hasError = true),
                ))
                ..loadRequest(Uri.parse('https://lightslategray-pheasant-815893.hostingersite.com/dashboard.php'));

              if (controller.platform is AndroidWebViewController) {
                (controller.platform as AndroidWebViewController).setGeolocationPermissionsPromptCallbacks(
                  onShowPrompt: (request) async => GeolocationPermissionsResponse(allow: true, retain: true),
                );
              }
            }

            @override
            Widget build(BuildContext context) {
              return PopScope(
                canPop: false,
                onPopInvoked: (didPop) async {
                  if (didPop) return;
                  if (await controller.canGoBack()) {
                    controller.goBack();
                  } else {
                    SystemChannels.platform.invokeMethod('SystemNavigator.pop');
                  }
                },
                child: Scaffold(
                  backgroundColor: Colors.white,
                  body: Stack(
                    children: [
                      if (!hasError) WebViewWidget(controller: controller),
                      if (isLoading && !hasError) const Center(child: CircularProgressIndicator(color: Colors.green)),
                      if (hasError) _buildErrorUI(),
                    ],
                  ),
                ),
              );
            }

            Widget _buildErrorUI() {
              return Container(
                color: Colors.white,
                child: Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(Icons.wifi_off_rounded, size: 80, color: Colors.green),
                      const SizedBox(height: 20),
                      const Text("انٹرنیٹ یا لوکیشن کا مسئلہ ہے", 
                        style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, fontFamily: 'Arial')),
                      const SizedBox(height: 30),
                      ElevatedButton(
                        onPressed: () {
                          setState(() => hasError = false);
                          controller.reload();
                        },
                        style: ElevatedButton.styleFrom(backgroundColor: Colors.green, padding: EdgeInsets.symmetric(horizontal: 40, vertical: 15)),
                        child: const Text("دوبارہ کوشش کریں", style: TextStyle(color: Colors.white, fontSize: 16)),
                      ),
                    ],
                  ),
                ),
              );
            }
          }
          EOF

          # اینڈرائیڈ کی مینی فیسٹ فائل میں پرمیشنز ڈالنا
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />' android/app/src/main/AndroidManifest.xml
          
          cd android && chmod +x gradlew && ./gradlew clean && cd ..
          flutter build apk --release --split-per-abi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Masail-ka-Hal-Professional-Final
          path: build/app/outputs/flutter-apk/*.apk
