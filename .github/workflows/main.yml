name: Professional App - Masail ka Hal
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: Auto-Generate Masail ka Hal App
        run: |
          # پروجیکٹ بنانا
          flutter create --project-name=masail_ka_hal --platforms=android .
          flutter pub add webview_flutter
          flutter pub add flutter_launcher_icons
          
          # ایپ کا نام سیٹ کرنا
          sed -i 's/android:label="masail_ka_hal"/android:label="Masail ka Hal"/' android/app/src/main/AndroidManifest.xml

          # آئیکن کی مکمل کنفیگریشن
          cat <<EOF > flutter_launcher_icons.yaml
          flutter_launcher_icons:
            android: true
            image_path: "icon.png"
            remove_alpha_ios: true
          EOF

          # مین ایپ کوڈ (لوڈنگ اور ایرر ہینڈلنگ)
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:webview_flutter/webview_flutter.dart';

          void main() => runApp(const MaterialApp(home: SafeArea(child: AppBody()), debugShowCheckedModeBanner: false));

          class AppBody extends StatefulWidget {
            const AppBody({super.key});
            @override
            State<AppBody> createState() => _AppBodyState();
          }

          class _AppBodyState extends State<AppBody> {
            late final WebViewController controller;
            bool isLoading = true;
            bool hasError = false;

            @override
            void initState() {
              super.initState();
              controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..setNavigationDelegate(
                  NavigationDelegate(
                    onPageStarted: (url) => setState(() { isLoading = true; hasError = false; }),
                    onPageFinished: (url) => setState(() { isLoading = false; }),
                    onWebResourceError: (error) => setState(() { hasError = true; isLoading = false; }),
                  ),
                )
                ..loadRequest(Uri.parse('https://lightslategray-pheasant-815893.hostingersite.com/dashboard.html'));
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                body: Stack(
                  children: [
                    if (!hasError) WebViewWidget(controller: controller),
                    if (isLoading) const Center(child: CircularProgressIndicator(color: Colors.green)),
                    if (hasError) _buildErrorPage(),
                  ],
                ),
              );
            }

            Widget _buildErrorPage() {
              return Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Icon(Icons.wifi_off, size: 80, color: Colors.grey),
                    const SizedBox(height: 20),
                    const Text("انٹرنیٹ موجود نہیں ہے", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.black)),
                    const SizedBox(height: 10),
                    ElevatedButton(
                      style: ElevatedButton.styleFrom(backgroundColor: Colors.green),
                      onPressed: () => controller.reload(),
                      child: const Text("دوبارہ کوشش کریں", style: TextStyle(color: Colors.white)),
                    )
                  ],
                ),
              );
            }
          }
          EOF

          # آئیکن اپلائی کرنا
          flutter pub run flutter_launcher_icons

          # پرمیشنز
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          
          # بلڈ
          flutter build apk --release --split-per-abi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Masail-ka-Hal-Final
          path: build/app/outputs/flutter-apk/*.apk
