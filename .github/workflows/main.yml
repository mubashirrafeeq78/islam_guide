name: Secure App - Domain Control Fix
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'

      - name: Master Build
        run: |
          flutter create --project-name=masail_ka_hal --platforms=android . || true
          # ضروری لائبریریز شامل کرنا
          flutter pub add webview_flutter http permission_handler webview_flutter_android || true
          
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';
          import 'package:webview_flutter/webview_flutter.dart';
          import 'package:webview_flutter_android/webview_flutter_android.dart';
          import 'package:http/http.dart' as http;
          import 'package:permission_handler/permission_handler.dart';

          void main() => runApp(const MaterialApp(home: SafeArea(child: AppBody()), debugShowCheckedModeBanner: false));

          class AppBody extends StatefulWidget {
            const AppBody({super.key});
            @override State<AppBody> createState() => _AppBodyState();
          }

          class _AppBodyState extends State<AppBody> {
            WebViewController? controller;
            bool isLoading = true;
            String? targetUrl;

            @override
            void initState() {
              super.initState();
              _startApp();
            }

            Future<void> _startApp() async {
              // لوکیشن پرمیشن
              await Permission.location.request();
              
              try {
                // آپ کی گٹ ہب فائل سے لنک پڑھنا
                final response = await http.get(Uri.parse('https://raw.githubusercontent.com/mubashirrafeeq78/islam_guide/main/app_config.txt'));
                if (response.statusCode == 200) {
                  targetUrl = response.body.trim();
                }
              } catch (e) {
                // ایمرجنسی بیک اپ لنک
                targetUrl = 'https://lightslategray-pheasant-815893.hostingersite.com/dashboard.php';
              }

              if (targetUrl != null) {
                _initController();
              }
            }

            void _initController() {
              final WebViewController vnt = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..addJavaScriptChannel(
                  'Flutter',
                  onMessageReceived: (JavaScriptMessage message) {
                    // مینو بدلنے پر ہسٹری چیک کرنے کی ضرورت نہیں، URL چیک کافی ہے
                  },
                )
                ..setNavigationDelegate(NavigationDelegate(
                  onPageStarted: (url) => setState(() => isLoading = true),
                  onPageFinished: (url) => setState(() => isLoading = false),
                ))
                ..loadRequest(Uri.parse(targetUrl!));

              // لوکیشن پرمیشن ہینڈلر
              if (vnt.platform is AndroidWebViewController) {
                (vnt.platform as AndroidWebViewController).setGeolocationPermissionsPromptCallbacks(
                  onShowPrompt: (request) async => GeolocationPermissionsResponse(allow: true, retain: true),
                );
              }

              setState(() {
                controller = vnt;
              });
            }

            @override
            Widget build(BuildContext context) {
              return PopScope(
                canPop: false,
                onPopInvoked: (didPop) async {
                  if (didPop || controller == null) return;
                  
                  final String? currentUrl = await controller!.currentUrl();
                  final bool canGoBack = await controller!.canGoBack();

                  // اگر صارف ڈیش بورڈ پر ہے تو ایپ بند کر دیں
                  if (currentUrl != null && currentUrl.contains('dashboard.php')) {
                    SystemChannels.platform.invokeMethod('SystemNavigator.pop');
                  } else if (canGoBack) {
                    controller!.goBack();
                  } else {
                    SystemChannels.platform.invokeMethod('SystemNavigator.pop');
                  }
                },
                child: Scaffold(
                  backgroundColor: Colors.white,
                  body: controller == null 
                    ? const Center(child: CircularProgressIndicator(color: Colors.green))
                    : Stack(
                        children: [
                          WebViewWidget(controller: controller!),
                          if (isLoading) const Center(child: CircularProgressIndicator(color: Colors.green)),
                        ],
                      ),
                ),
              );
            }
          }
          EOF

          # اینڈرائیڈ کی مینی فیسٹ میں پرمیشنز ڈالنا
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />' android/app/src/main/AndroidManifest.xml

          cd android && chmod +x gradlew && ./gradlew clean && cd ..
          flutter build apk --release --split-per-abi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Masail-ka-Hal-Final-Super-Secure
          path: build/app/outputs/flutter-apk/*.apk
