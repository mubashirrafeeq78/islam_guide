name: Final Final Success Build
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Fix Kotlin in New Template
        run: |
          # 1. مکمل صفائی
          rm -rf android .idea
          
          # 2. نیا پروجیکٹ بنانا
          flutter create --platforms=android --project-name=masail_ka_hal .
          
          # 3. نئے طریقے کے مطابق Kotlin ورژن ٹھیک کرنا (Settings.gradle میں)
          # یہ وہ جگہ ہے جہاں اب فلٹر ورژن محفوظ کرتا ہے
          sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.22" apply false/g' android/settings.gradle
          
          # 4. اینڈرائیڈ SDK ورژن کو 35 پر سیٹ کرنا (جیسا کہ لاگ میں مانگا گیا تھا)
          sed -i 's/compileSdk = .*/compileSdk = 35/g' android/app/build.gradle
          
          # 5. ضروری پیکیجز
          flutter pub add webview_flutter webview_flutter_android permission_handler location
          
          # 6. ایپ کوڈ
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:webview_flutter/webview_flutter.dart';
          void main() => runApp(MaterialApp(
            debugShowCheckedModeBanner: false,
            home: Scaffold(
              body: SafeArea(
                child: WebViewWidget(
                  controller: WebViewController()
                    ..setJavaScriptMode(JavaScriptMode.unrestricted)
                    ..loadRequest(Uri.parse('https://lightslategray-pheasant-815893.hostingersite.com/dashboard.php')),
                ),
              ),
            ),
          ));
          EOF

          # 7. انٹرنیٹ پرمیشن
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml

          # 8. بلڈ
          flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Success-APK
          path: build/app/outputs/flutter-apk/app-release.apk
