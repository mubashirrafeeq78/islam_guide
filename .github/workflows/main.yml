name: Guaranteed Success Build
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Bulletproof Build Process
        run: |
          # 1. پرانا کچرا صاف کریں
          rm -rf android .idea
          
          # 2. نیا صاف پروجیکٹ بنائیں
          flutter create --platforms=android --project-name=masail_ka_hal .
          
          # 3. Kotlin ورژن کو settings.gradle میں ہارڈ کوڈ کریں (1.9.10 سب سے محفوظ ہے)
          sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.10" apply false/g' android/settings.gradle
          
          # 4. اینڈرائیڈ SDK 34 استعمال کریں (تاکہ ریسورس لنکنگ ایرر نہ آئے)
          sed -i 's/compileSdk = .*/compileSdk = 34/g' android/app/build.gradle
          
          # 5. پیکیجز شامل کریں
          flutter pub add webview_flutter webview_flutter_android
          
          # 6. مین کوڈ (صرف ویب ویو کے لیے، تاکہ لوکیشن کی وجہ سے بلڈ نہ رکے)
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:webview_flutter/webview_flutter.dart';

          void main() => runApp(const MaterialApp(
            debugShowCheckedModeBanner: false,
            home: Scaffold(
              body: SafeArea(
                child: WebApp(),
              ),
            ),
          ));

          class WebApp extends StatefulWidget {
            const WebApp({super.key});
            @override State<WebApp> createState() => _WebAppState();
          }

          class _WebAppState extends State<WebApp> {
            late final WebViewController _controller;
            @override
            void initState() {
              super.initState();
              _controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..loadRequest(Uri.parse('https://lightslategray-pheasant-815893.hostingersite.com/dashboard.php'));
            }
            @override
            Widget build(BuildContext context) => WebViewWidget(controller: _controller);
          }
          EOF

          # 7. انٹرنیٹ پرمیشن شامل کریں
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml

          # 8. کلین بلڈ
          flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Masail-Final-APK
          path: build/app/outputs/flutter-apk/app-release.apk
