name: Final Fix - Masail ka Hal
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Full Project Regeneration with Permissions
        run: |
          # 1. پرانی فائلیں صاف کریں
          find . -maxdepth 1 ! -name 'icon.png' ! -name '.github' ! -name '.git' -exec rm -rf {} +
          
          # 2. نیا پروجیکٹ بنائیں
          flutter create . --project-name masail_ka_hal --org com.mubashir
          
          # 3. انٹرنیٹ کی اجازت (Permissions) شامل کریں (یہ سب سے اہم ہے)
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />\n    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' android/app/src/main/AndroidManifest.xml

          # 4. درست URL اور خوبصورت ایرر ہینڈلنگ والا کوڈ
          mkdir -p lib
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:webview_flutter/webview_flutter.dart';

          void main() => runApp(const MaterialApp(
            debugShowCheckedModeBanner: false,
            home: SecureBrowser(),
          ));

          class SecureBrowser extends StatefulWidget {
            const SecureBrowser({super.key});
            @override
            State<SecureBrowser> createState() => _SecureBrowserState();
          }

          class _SecureBrowserState extends State<SecureBrowser> {
            late final WebViewController controller;
            bool hasError = false;

            @override
            void initState() {
              super.initState();
              controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..setBackgroundColor(Colors.white)
                ..setNavigationDelegate(NavigationDelegate(
                  onPageFinished: (url) => setState(() => hasError = false),
                  onWebResourceError: (error) => setState(() => hasError = true),
                ))
                ..loadRequest(Uri.parse('https://lightslategray-pheasant-815893.hostingersite.com/dashboard.php'));
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                backgroundColor: Colors.white,
                body: SafeArea(
                  child: hasError 
                    ? Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            const Icon(Icons.wifi_off_rounded, size: 100, color: Color(0xFF5D5D7E)),
                            const SizedBox(height: 20),
                            const Text("رابطہ منقطع ہے", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Color(0xFF333333))),
                            const Padding(
                              padding: EdgeInsets.symmetric(horizontal: 40, vertical: 10),
                              child: Text("براہِ کرم اپنا انٹرنیٹ چیک کریں اور دوبارہ کوشش کریں", textAlign: TextAlign.center, style: TextStyle(color: Colors.grey)),
                            ),
                            const SizedBox(height: 20),
                            ElevatedButton(
                              onPressed: () {
                                setState(() => hasError = false);
                                controller.reload();
                              },
                              style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFFF7F2FA), foregroundColor: Colors.purple, elevation: 0, padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 12)),
                              child: const Text("دوبارہ لوڈ کریں", style: TextStyle(fontSize: 16)),
                            )
                          ],
                        ),
                      )
                    : WebViewWidget(controller: controller),
                ),
              );
            }
          }
          EOF

          # 5. آئیکون اور سورس کوڈ کی سیٹنگ
          cat <<EOF > pubspec.yaml
          name: masail_ka_hal
          environment:
            sdk: '>=3.0.0 <4.0.0'
          dependencies:
            flutter:
              sdk: flutter
            webview_flutter: ^4.4.2
          dev_dependencies:
            flutter_launcher_icons: ^0.13.1
          flutter_launcher_icons:
            android: true
            ios: true
            image_path: "icon.png"
          flutter:
            uses-material-design: true
          EOF
          
          flutter pub get
          if [ -f "icon.png" ]; then flutter pub run flutter_launcher_icons; fi

      - name: Build APK
        run: flutter build apk --release

      - name: Upload Final APK
        uses: actions/upload-artifact@v4
        with:
          name: Masail_ka_Hal_App
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Sync Source Code to Repo
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Complete source code with permissions and fix" || echo "No changes to commit"
          git push origin main
