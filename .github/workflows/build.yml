name: Final Master Build
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Master Setup
        run: |
          # 1. پروجیکٹ دوبارہ بنانا (بغیر پرانی فائلیں چھیڑے)
          flutter create . --project-name masail_ka_hal --org com.mubashir --force
          
          # 2. انٹرنیٹ اور GPS کی اجازتیں شامل کرنا
          # ہم نے GPS اور انٹرنیٹ کی تمام ضروری پرمیشنز یہاں ڈال دی ہیں
          cat <<EOF > android/app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              <application
                  android:label="Masail ka Hal"
                  android:name="\${applicationName}"
                  android:icon="@mipmap/ic_launcher">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <meta-data android:name="io.flutter.embedding.android.NormalTheme" android:resource="@style/NormalTheme" />
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  <meta-data android:name="flutterEmbedding" android:value="2" />
              </application>
          </manifest>
          EOF

          # 3. مین براؤزر کوڈ (GPS سپورٹ اور اردو ایرر پیج کے ساتھ)
          mkdir -p lib
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:webview_flutter/webview_flutter.dart';
          import 'package:webview_flutter_android/webview_flutter_android.dart';

          void main() => runApp(const MaterialApp(debugShowCheckedModeBanner: false, home: SecureBrowser()));

          class SecureBrowser extends StatefulWidget {
            const SecureBrowser({super.key});
            @override
            State<SecureBrowser> createState() => _SecureBrowserState();
          }

          class _SecureBrowserState extends State<SecureBrowser> {
            late final WebViewController controller;
            bool hasError = false;

            @override
            void initState() {
              super.initState();
              controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..setNavigationDelegate(NavigationDelegate(
                  onPageFinished: (url) => setState(() => hasError = false),
                  onWebResourceError: (error) => setState(() => hasError = true),
                ))
                ..loadRequest(Uri.parse('https://lightslategray-pheasant-815893.hostingersite.com/dashboard.php'));
              
              if (controller.platform is AndroidWebViewController) {
                (controller.platform as AndroidWebViewController).setGeolocationEnabled(true);
              }
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                body: SafeArea(
                  child: hasError 
                  ? Center(child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [
                      const Icon(Icons.wifi_off, size: 80, color: Colors.red),
                      const Text("رابطہ منقطع ہے", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                      ElevatedButton(onPressed: () { setState(() => hasError = false); controller.reload(); }, child: const Text("دوبارہ کوشش کریں"))
                    ]))
                  : WebViewWidget(controller: controller),
                ),
              );
            }
          }
          EOF

          # 4. آئیکون اور سیٹنگز
          cat <<EOF > pubspec.yaml
          name: masail_ka_hal
          environment:
            sdk: '>=3.0.0 <4.0.0'
          dependencies:
            flutter:
              sdk: flutter
            webview_flutter: ^4.4.2
            webview_flutter_android: ^3.10.1
          dev_dependencies:
            flutter_launcher_icons: ^0.13.1
          flutter_launcher_icons:
            android: true
            ios: true
            image_path: "icon.png"
          flutter:
            uses-material-design: true
          EOF

          flutter pub get
          if [ -f "icon.png" ]; then flutter pub run flutter_launcher_icons; fi

      - name: Build APK
        run: flutter build apk --release

      - name: Sync To GitHub
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .
          git commit -m "Final Secure Build with GPS" || echo "No changes"
          git push origin main

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Masail_ka_Hal_App
          path: build/app/outputs/flutter-apk/app-release.apk
