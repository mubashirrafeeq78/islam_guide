name: Super-iFrame-Engine
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'

      - name: Create Project & Inject iFrame Logic
        run: |
          # 1. پروجیکٹ بنانا
          flutter create --project-name=masail_ka_hal --platforms=android . || true
          
          # 2. خاص iFrame نیویگیشن کوڈ لکھنا
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:webview_flutter/webview_flutter.dart';

          void main() => runApp(const MaterialApp(home: SafeArea(child: AppBody()), debugShowCheckedModeBanner: false));

          class AppBody extends StatefulWidget {
            const AppBody({super.key});
            @override
            State<AppBody> createState() => _AppBodyState();
          }

          class _AppBodyState extends State<AppBody> {
            late final WebViewController controller;
            bool isLoading = true;

            @override
            void initState() {
              super.initState();
              controller = WebViewController()
                ..setJavaScriptMode(JavaScriptMode.unrestricted)
                ..setNavigationDelegate(NavigationDelegate(
                  onPageStarted: (url) => setState(() => isLoading = true),
                  onPageFinished: (url) => setState(() => isLoading = false),
                ))
                ..loadRequest(Uri.parse('https://lightslategray-pheasant-815893.hostingersite.com/dashboard.html'));
            }

            @override
            Widget build(BuildContext context) {
              return PopScope(
                canPop: false,
                onPopInvoked: (didPop) async {
                  if (didPop) return;
                  
                  // iFrame کی ہسٹری چیک کرنے کے لیے جاوا اسکرپٹ کا استعمال
                  final canGoBackInIframe = await controller.runJavaScriptReturningResult(
                    "window.history.length > 1"
                  );

                  if (canGoBackInIframe == true) {
                    controller.runJavaScript("window.history.back();");
                  } else {
                    if (context.mounted) Navigator.of(context).pop(); 
                  }
                },
                child: Scaffold(
                  body: Stack(
                    children: [
                      WebViewWidget(controller: controller),
                      if (isLoading) const Center(child: CircularProgressIndicator(color: Colors.green)),
                    ],
                  ),
                ),
              );
            }
          }
          EOF

          # 3. فائلیں سیو کرنا اور بلڈ بنانا
          git config --global user.email "bot@github.com"
          git config --global user.name "Super Bot"
          git add .
          git commit -m "Generated with iFrame Navigation Support"
          git push || true
          
          chmod +x android/gradlew
          flutter pub get
          flutter build apk --release --target-platform android-arm64

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Final-iFrame-App
          path: build/app/outputs/flutter-apk/app-release.apk
